# Анализ контракта взаимодействия

## Условие

Дан эндпоинт `POST /add-items-to-cart`, добавляющий предметы в корзину пользователя, со следующим контрактом:

Структура:
* ID пользователя
* Объект корзины
  * Массив предметов
    * ID предмета
    * Количество

```json
{
  "user_id": 0,
  "cart": {
    "items": [
      {
        "item_id": 0,
        "quantity": 0
      }
    ]
  }
}
```

В ответ возвращает новое состояние объекта корзины и суммарную стоимость предметов в ней.

```json
{
  "cart": {
    "items": [
      {
        "item_id": 0,
        "name": "string",
        "description": "string",
        "quantity": 0,
        "price": 0
      }
    ]
  },
  "total_price": 0
}
```

### Пример запроса и ответа

Запрос

```json
{
  "user_id": 228,
  "cart": {
    "items": [
      {
        "item_id": 2,
        "quantity": 3
      },
      {
        "item_id": 3,
        "quantity": 10
      }
    ]
  }
}
```

Ответ
```json
{
  "cart": {
    "items": [
      {
        "item_id": 2,
        "name": "Сталин-3000",
        "description": "Третьего дня, по совету проверенных комрадов...",
        "quantity": 3,
        "price": 1500
      },
      {
        
        "item_id": 3,
        "name": "iPhone 15 Pro 1 TB",
        "description": "Айфончик новый",
        "quantity": 10,
        "price": 200000
      }
    ]
  },
  "total_price": 2004500
}
```

Что нужно проверить при тестировании данного эндпоинта?

## Решение

Cледует убедиться, что передаваемый `user_id` в принципе существует. Если нет, то следует вернуть статус код 400.

После этого нужно посмотреть на `item_id` в массиве `items`. В случае, если передаваемый `item_id` не существует, то тоже нужно вернуть клиентскую ошибку, можно возвращать и 400, и 404. 

Важным критерием станет, хватит ли на этого пользователя предметов с переданным `item_id`. Нужно проверять, что итоговая `quantity` не превышает количества предметов в хранилище. Если превышает, то нужно вернуть статус код 400.

Стоит задуматься о том, что в запрос можно подставить `user_id` любого пользователя. Если сервис с таким эндпоинтом не взаимодействует напрямую с фронтэндом, а между ними есть какая-то прослойка занимающаяся валидацией, то мы можем не обращать внимание на значение в данном поле. Но если мы получаем запрос без предварительной валидации, то тогда нам потребуется какой-то токен, чтобы отсеивать ситуации, при которых пользователь хочет поменять чужую корзину. Если пользователь хочет поменять корзину другого, то следует отдавать статус код 403.

Также, можно проверять, что приложение корректно обрабатывает ситуации несоответсвия типов. Например, если передать вместо целого числа в качестве `user_id` какую-то строку или дробь. Если есть несоответсвие типов, то вернем статус код 400.

Необходимо убедиться что все поля заполнены, так как они все обязательны. Если какое-то поле отсутствует в запросе, следует вернуть статус код 400.

Если есть какие-то лишние поля, то можно возвращать статус код 400 или игнорировать их.

В ответе следует проверить, что поля `quantity` и `item_id` совпадают с переданными, а `total_price` - корректная сумма всех предметов с учетом их количества.