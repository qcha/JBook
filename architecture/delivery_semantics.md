# Семантики доставки сообщений

## Введение

Любая система обмена сообщениями в общем виде принимает сообщение от отправителя и доставляет его получателю. При этом она предоставляет некоторые гарантии доставки, особенно в случае возникновения проблем.

Технически оправданы три семантики доставки:

* `At-most-once delivery` - сообщение может быть доставлено один раз или никогда не доставлено, т.е **допускается** потеря сообщения.

* `At-least-once delivery` - сообщение будет доставлено один или более раз, т.е никогда не будет потеряно.
  
  Плата за надежность - возможное появление дублей доставляемого сообщения, так как при ошибке доставки сообщения будут предприняты повторные отправки.

* `Exactly-once delivery` - гарантированная доставка сообщения строго один раз.
  
    Вариант, который каждый представляет у себя в голове, когда заходит речь о системе обмена сообщениями.

## Разбор

Система отправляет сообщение, при получении происходит непредвиденная ситуация и получатель на некоторое время выходит из строя.

### Доставка at-most-once

При выборе семантики `at-most-once` сообщение теряется, так как оно не было обработано.

Грубо говоря, в таком случае нет никаких гарантий доставки - оно либо будет доставлено, либо нет. Это чистый `fire-and-foget`.

Однако это не означает, что такая семантика доставки бесполезна. Для примера использования можно представить датчик дома, который публикует данные о температуре в комнате, если мы потеряем данные за последние полторы минуты о темературе в комнате - это вполне допустимая погрешность работы.

Это как известная шутка-анекдот про [UDP](https://ru.wikipedia.org/wiki/UDP)-протокол:

> Я знаю отличную шутку про UDP, но не факт, что она до вас дойдет.

### Доставка at-least-once

На практике в большинстве случаев такие гарантии не устраивают, поэтому при получении сообщения получатель должен отправить какое-то подтверждение того, что сообщение получено. Нет подтверждения - предпринимаются попытки отправить сообщение еще раз.

В случае, если подтверждение теряется или не успевает прийти от получателя, отправитель может отправить сообщение несколько раз и несколько раз оно будет обработано, т.е возможно появление дублей сообщения.

Например, получатель был занят обработкой полученного сообщения и не успел во время отправить подтверждение получения.

В таком случае он обработает первое сообщение, отправит подтверждение, в то время как отправитель посчитает, что сообщение не доставлено, и снова повторит отправку уже второго сообщения! Второе отправленное сообщение — сообщение-дубль!

Затем отправитель получает запоздалое подтверждение по первому сообщение и прекращает отправку. Далее получателю приходит второе сообщение, сообщение-дубль, которое предстоит обработать. В итоге было доставлено и обработано два одинаковых сообщения.

Однако сообщение может быть перенаправлено другому получателю, если первый все еще не умер, но тогда оно будет обработано также два раза.

Такое поведение происходит при `at-least-once` доставке.

![at-least-once](../images/architecture/delivery_semantics/at-least-once.jpg)

> Например, на [Apache Kafka](../kafka/intro.md) реализован механизм кольцевого буфера, когда сообщения хранятся некоторый промежуток времени и только потом удаляются.

Ну и самый сложный в реализации вариант - `exactly-once` доставка.

### Доставка exactly-once

В таком случае повторить доставку или перенаправить на другой обработчик нельзя, как в случаях, описанных выше.

Чтобы избежать дубликатов, придется каким-то образом маркировать сообщения при отправке и проверять их при получении.  Это потребует синхронизацию между отправителем и получателем, что негативно скажется на общей производительности. Либо придется реализовать обходное решение на уровне бизнес-логики, другими словами получателя придется самостоятельно отсеивать дубликаты.

Реализация `exactly-once` дается дорого - ценой масштабирования, производительности, низкой связанности или же усложнением бизнес-логики.

Из-за высокой цены реализации стоит дважды подумать о реальной необходимости использования `exactly-once`.

## Полезные ссылки

1. [Гарантии доставки](http://bavadim.me/programming/2015/09/05/ExaclyOnce.html)
2. [Exactly-Once Delivery May Not Be What You Want](http://brooker.co.za/blog/2014/11/15/exactly-once.html)
3. [You Cannot Have Exactly-Once Delivery](https://bravenewgeek.com/you-cannot-have-exactly-once-delivery/)
